<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å·è¥¿å¯’å‡å‡ºæ¸¸æ—¶é—´åè°ƒ</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",sans-serif;background:linear-gradient(180deg,#eaf2ff,#f7f8fa);color:#333}
    header{text-align:center;padding:28px 16px 14px}
    header h1{margin:0;font-size:26px}
    header p{margin-top:8px;color:#666;font-size:14px}
    .container{max-width:1100px;margin:auto;padding:16px}
    .card{background:#fff;border-radius:16px;padding:18px;margin-bottom:18px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
    .row{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:980px){.row{grid-template-columns:360px 1fr}}

    label{display:block;font-weight:600;margin-bottom:6px}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;font-size:15px}

    .dates{margin-top:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(92px,1fr));gap:8px;max-height:260px;overflow-y:auto}
    .date{background:#f0f2f5;border-radius:10px;padding:8px 4px;text-align:center;font-size:12px;cursor:pointer;user-select:none}
    .date.selected{background:linear-gradient(135deg,#4facfe,#00f2fe);color:#fff;font-weight:700}

    button{margin-top:14px;width:100%;padding:12px;border-radius:12px;border:none;font-size:16px;background:linear-gradient(135deg,#1677ff,#69b1ff);color:#fff;cursor:pointer}
    .hint{font-size:12px;color:#888;margin-top:6px;line-height:1.4}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#f0f2f5;color:#555;font-size:12px;margin-left:8px}

    /* matrix */
    .matrixWrap{overflow:auto;border-radius:14px;border:1px solid #eee;max-height:420px}
    table{width:max-content;min-width:100%;border-collapse:separate;border-spacing:0;font-size:13px}
    th,td{padding:6px 6px;border-bottom:1px solid #f1f1f1;white-space:nowrap}
    thead th{position:sticky;top:0;background:#fff;z-index:2}
    .stickyCol{position:sticky;left:0;background:#fff;z-index:3;border-right:1px solid #f1f1f1}
    .cell{width:14px;height:14px;border-radius:4px;display:inline-block}
    .free{background:#2ecc71}
    .busy{background:#e6e8ec}
    .count8{color:#2ecc71;font-weight:700}
    .count6{color:#f39c12;font-weight:700}
    .countLow{color:#999}

    .matrixTools{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px}
    .matrixTools button{width:auto;padding:6px 10px;font-size:13px;border-radius:8px}

    .err{color:#c0392b;font-size:12px;margin-top:8px}
  </style>
</head>
<body>
<header>
  <h1>ğŸ”ï¸ å·è¥¿å¯’å‡å‡ºæ¸¸æ—¶é—´åè°ƒ</h1>
  <p>æœ€ç»ˆç‰ˆï¼šå®æ—¶åŒæ­¥ + å¯è§†åŒ–æ—¶é—´è½´ï¼ˆ1/10â€“2/20ï¼‰</p>
</header>

<div class="container">
  <div class="row">

    <div class="card">
      <label>ä½ çš„æ˜µç§°ï¼ˆå”¯ä¸€ï¼‰<span class="pill" id="countPill">å·²é€‰ 0 å¤©</span></label>
      <input id="nameInput" placeholder="ä¾‹å¦‚ï¼šé˜¿æ°" />

      <label style="margin-top:12px">ç‚¹é€‰ä½ å¯ä»¥å‡ºæ¸¸çš„æ—¥æœŸ</label>
      <div id="dates" class="dates"></div>

      <button onclick="save()">ä¿å­˜ / æ›´æ–°æˆ‘çš„æ—¶é—´</button>
      <div class="hint">
        è¯´æ˜ï¼šç»¿è‰²è¡¨ç¤ºä½ â€œå¯å‡ºæ¸¸â€çš„æ—¥æœŸã€‚<br/>
        å®æ—¶åŒæ­¥ï¼šä»»ä½•äººä¿å­˜åï¼Œæ‰€æœ‰äººçš„æ±‡æ€»ä¼šç«‹åˆ»æ›´æ–°ã€‚<br/>
        å¦‚æœä½ å‘ç°â€œå·²é€‰å¤©æ•°â€å¼‚å¸¸ï¼Œé€šå¸¸æ˜¯å†å²æ•°æ®é‡Œ dates å­—æ®µä¸æ˜¯æ•°ç»„â€”â€”æœ¬é¡µä¼šè‡ªåŠ¨å…¼å®¹å¹¶ä¿®æ­£ã€‚
      </div>
      <div class="err" id="saveErr" style="display:none"></div>
    </div>

    <div class="card">
      <div class="matrixTools">
        <button onclick="setWindow(7)">è¿‘ 7 å¤©</button>
        <button onclick="setWindow(14)">è¿‘ 14 å¤©</button>
        <button onclick="setWindow(30)">è¿‘ 30 å¤©</button>
        <button onclick="setWindow(0)">å…¨éƒ¨</button>
      </div>
      <div class="recommend" id="recommend"></div>
      <div class="hint" style="margin-top:10px">
        ä¸‹é¢æ˜¯ã€ŒæŒ‰æ—¥æœŸã€çš„å¯è§†åŒ–ï¼šæ¯åˆ—ä¸€å¤©ï¼Œæ¯è¡Œä¸€ä¸ªäººã€‚ç»¿è‰²=ç©ºé—²ï¼Œç°è‰²=æœ‰äº‹/ä¸å¯å‡ºæ¸¸ã€‚å·¦ä¾§æœ‰æ¯å¤©å¯è¡Œäººæ•°ã€‚
      </div>
      <div class="matrixWrap" style="margin-top:10px">
        <table id="matrix"></table>
      </div>
      <div class="legend">
        <span><i class="cell free"></i>å¯å‡ºæ¸¸</span>
        <span><i class="cell busy"></i>ä¸å¯å‡ºæ¸¸</span>
        <span>äººæ•°ï¼š<b class="count8">8</b> å…¨å‘˜</span>
        <span>äººæ•°ï¼š<b class="count6">â‰¥6</b> å¤§å¤šæ•°</span>
      </div>
    </div>

  </div>
</div>

<script>
  // â¬‡ï¸ ä¿æŒä½ è‡ªå·±çš„ Supabase ä¿¡æ¯
  const SUPABASE_URL = "YOUR_SUPABASE_URL";
  const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const start = new Date(2025, 0, 10); // 2025-01-10ï¼ˆæœ¬åœ°æ—¶åŒºï¼‰
  const end   = new Date(2025, 1, 20); // 2025-02-20ï¼ˆæœ¬åœ°æ—¶åŒºï¼‰

  const datesDiv = document.getElementById('dates');
  const matrixEl = document.getElementById('matrix');
  const countPill = document.getElementById('countPill');
  const recEl = document.getElementById('recommend');
  const saveErr = document.getElementById('saveErr');

  const selected = new Set();
  const dateCells = new Map(); // dateStr -> div

  function fmt(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function mmdd(dateStr){
    return dateStr.slice(5).replace('-', '/');
  }

  function normalizeDates(val){
    // å…¼å®¹å†å²æ•°æ®ï¼štext[] / jsonb array / é€—å·å­—ç¬¦ä¸² / JSON å­—ç¬¦ä¸²
    if (Array.isArray(val)) return val.filter(Boolean);
    if (val == null) return [];
    if (typeof val === 'string') {
      const s = val.trim();
      if (!s) return [];
      if (s.startsWith('[') && s.endsWith(']')) {
        try {
          const parsed = JSON.parse(s);
          return Array.isArray(parsed) ? parsed.filter(Boolean) : [];
        } catch { /* ignore */ }
      }
      // å…œåº•ï¼šé€—å·åˆ†éš”
      return s.split(',').map(x=>x.trim()).filter(Boolean);
    }
    // å…¶ä»–ç±»å‹ï¼ˆæ¯”å¦‚å¯¹è±¡ï¼‰
    try {
      const parsed = JSON.parse(String(val));
      return Array.isArray(parsed) ? parsed.filter(Boolean) : [];
    } catch {
      return [];
    }
  }

  function updateCountPill(){
    countPill.textContent = `å·²é€‰ ${selected.size} å¤©`;
  }

  // ç”Ÿæˆæ—¥æœŸæŒ‰é’®
  let allDates = [];
  let visibleDates = [];
  let windowSize = 0; // 0 = å…¨éƒ¨
  for (let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
    const s = fmt(d);
    allDates.push(s);
    const div = document.createElement('div');
    div.className = 'date';
    div.textContent = mmdd(s);
    div.onclick = () => {
      div.classList.toggle('selected');
      if (div.classList.contains('selected')) selected.add(s); else selected.delete(s);
      updateCountPill();
    };
    datesDiv.appendChild(div);
    dateCells.set(s, div);
  }
  updateCountPill();

  // è¯»å–æŸä¸ªæ˜µç§°çš„å·²ä¿å­˜é€‰æ‹©ï¼Œå¹¶å›å¡« UI
  async function hydrateSelectionForName(name){
    // æ¸…ç©ºå½“å‰é€‰æ‹©
    for (const s of selected) { const el = dateCells.get(s); if (el) el.classList.remove('selected'); }
    selected.clear();

    if (!name) { updateCountPill(); return; }

    const { data, error } = await sb.from('trip').select('dates').eq('name', name).maybeSingle();
    if (error) return; // ä¸æ‰“æ–­

    const arr = normalizeDates(data?.dates);
    for (const ds of arr) {
      if (dateCells.has(ds)) {
        selected.add(ds);
        dateCells.get(ds).classList.add('selected');
      }
    }
    updateCountPill();
  }

  // å½“æ˜µç§°è¾“å…¥å®Œæˆï¼ˆå¤±ç„¦ï¼‰æ—¶å›å¡«
  nameInput.addEventListener('blur', () => {
    hydrateSelectionForName(nameInput.value.trim());
  });

  async function save(){
    saveErr.style.display='none';
    const name = nameInput.value.trim();
    if(!name){alert('è¯·å¡«å†™æ˜µç§°');return}

    const dates = [...selected];
    const { error } = await sb.from('trip').upsert({ name, dates }, { onConflict: 'name' });
    if(error){
      saveErr.style.display='block';
      saveErr.textContent = 'ä¿å­˜å¤±è´¥ï¼š' + error.message;
      return;
    }
  }

  function renderRecommend(dateCounts, names){
    // æ‰¾â€œå…¨å‘˜å¯è¡Œâ€çš„æœ€é•¿è¿ç»­æ®µï¼›å¦‚æœæ²¡æœ‰ï¼Œæ‰¾â€œäººæ•°æœ€å¤šâ€çš„æœ€é•¿è¿ç»­æ®µ
    const best = { score: -1, len: 0, startIdx: -1, endIdx: -1, minCount: -1 };

    function consider(minCountTarget){
      let i=0;
      while(i<allDates.length){
        if(dateCounts[allDates[i]] >= minCountTarget){
          let j=i;
          while(j<allDates.length && dateCounts[allDates[j]] >= minCountTarget) j++;
          const len = j-i;
          const score = minCountTarget*1000 + len; // å…ˆäººæ•°å†é•¿åº¦
          if(score > best.score){
            best.score = score;
            best.len = len;
            best.startIdx = i;
            best.endIdx = j-1;
            best.minCount = minCountTarget;
          }
          i=j;
        } else i++;
      }
    }

    // ä¼˜å…ˆæ‰¾ 8 äººï¼Œå…¶æ¬¡ 7ã€6
    consider(names.length);
    if(best.score<0 && names.length>=7) consider(7);
    if(best.score<0 && names.length>=6) consider(6);

    // å¦‚æœä»ç„¶æ²¡æœ‰ï¼Œå°±æ‰¾äººæ•°æœ€é«˜çš„è¿ç»­æ®µï¼ˆ>=1ï¼‰
    if(best.score<0){
      let maxC = 0;
      for(const d of allDates) maxC = Math.max(maxC, dateCounts[d]||0);
      consider(maxC);
    }

    recEl.innerHTML = '';
    const card = document.createElement('div');
    card.className = 'recCard';

    if(best.startIdx===-1){
      card.innerHTML = `<div class="recTitle">æš‚æ— æ¨èçª—å£</div><div class="recSub">è¿˜æ²¡æœ‰äººå¡«å†™ï¼Œæˆ–æ²¡æœ‰ä»»ä½•ä¸€å¤©å¯è¡Œã€‚</div>`;
      recEl.appendChild(card);
      return;
    }

    const startD = allDates[best.startIdx];
    const endD = allDates[best.endIdx];
    card.innerHTML = `
      <div class="recTitle">æ¨èçª—å£ï¼š${startD} ï½ ${endD}</div>
      <div class="recSub">è¿ç»­ ${best.len} å¤©ï¼›æ¯ä¸€å¤©è‡³å°‘ ${best.minCount} äººå¯è¡Œï¼ˆå…± ${names.length} äººï¼‰</div>
    `;
    recEl.appendChild(card);
  }

  function setWindow(n){
    windowSize = n;
    load();
  }

  function renderMatrix(rows){
    // è®¡ç®—å¯è§æ—¥æœŸçª—å£
    visibleDates = windowSize>0 ? allDates.slice(0, windowSize) : allDates.slice();
    const names = (rows||[]).map(r=>r.name).sort((a,b)=>a.localeCompare(b,'zh'));

    // dateCounts
    const dateCounts = Object.fromEntries(allDates.map(d=>[d,0]));

    // map: name -> set(dates)
    const byName = new Map();
    for (const r of (rows||[])){
      const arr = normalizeDates(r.dates);
      const s = new Set(arr);
      byName.set(r.name, s);
      for(const d of arr){ if(dateCounts[d]!=null) dateCounts[d] += 1; }

      // ğŸ”§ å¦‚æœå†å²æ•°æ®ä¸æ˜¯æ•°ç»„ï¼ˆå¯¼è‡´â€œ66å¤©â€ï¼‰ï¼Œè¿™é‡Œé¡ºæ‰‹çº æ­£ä¸€æ¬¡ï¼ˆä¸æ‰“æ‰°ç”¨æˆ·ï¼‰
      if (!Array.isArray(r.dates) && r.name) {
        sb.from('trip').upsert({ name: r.name, dates: arr }, { onConflict: 'name' });
      }
    }

    renderRecommend(dateCounts, names);

    // build table
    let html = '';

    // header
    html += '<thead><tr>';
    html += '<th class="stickyCol">æˆå‘˜</th>';
    html += '<th class="stickyCol" style="left:72px">å¯è¡Œ</th>';
    for(const d of visibleDates){
      html += `<th title="${d}">${mmdd(d)}</th>`;
    }
    html += '</tr></thead>';

    // body: first row counts
    html += '<tbody>';
    html += '<tr>';
    html += '<td class="stickyCol" style="font-weight:700">æ¯å¤©äººæ•°</td>';
    html += '<td class="stickyCol" style="left:72px"></td>';
    for(const d of visibleDates){
      const c = dateCounts[d]||0;
      const cls = (c===names.length && names.length>0) ? 'count8' : (c>=6 ? 'count6' : 'countLow');
      html += `<td><span class="${cls}">${c}</span></td>`;
    }
    html += '</tr>';

    // each person row
    for(const name of names){
      const s = byName.get(name) || new Set();
      const freeCount = [...s].filter(d=>dateCells.has(d)).length;
      html += '<tr>';
      html += `<td class="stickyCol">${name}</td>`;
      html += `<td class="stickyCol" style="left:72px">${freeCount}</td>`;
      for(const d of visibleDates){
        const isFree = s.has(d);
        html += `<td><i class="cell ${isFree?'free':'busy'}" title="${name} Â· ${d} Â· ${isFree?'å¯å‡ºæ¸¸':'ä¸å¯å‡ºæ¸¸'}"></i></td>`;
      }
      html += '</tr>';
    }

    html += '</tbody>';

    matrixEl.innerHTML = html;
  }

  async function load(){
    const { data, error } = await sb.from('trip').select('name, dates');
    if (error) {
      matrixEl.innerHTML = `<tbody><tr><td>è¯»å–å¤±è´¥ï¼š${error.message}</td></tr></tbody>`;
      return;
    }
    renderMatrix(data || []);
  }

  // å®æ—¶è®¢é˜…ï¼šä»»ä½• INSERT / UPDATE / DELETE éƒ½ä¼šè§¦å‘é‡æ–°æ¸²æŸ“
  sb.channel('trip-realtime')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'trip' }, () => load())
    .subscribe();

  load();
</script>
</body>
</html>
